{
  "name": "My Grocery Helper",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {
          "download": true
        }
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        112
      ],
      "id": "b94e77c1-df85-4298-87a2-d6712171deab",
      "name": "Telegram Trigger",
      "webhookId": "c1b67c53-7c7d-493f-9c9a-1d86e11b4176",
      "credentials": {
        "telegramApi": {
          "id": "LJfZKhHnl2gO8FnK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "27cc2768-fda5-4a1c-a94e-27a2fea3a007",
              "leftValue": "={{ $json.message.photo && $json.message.photo.length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        208,
        112
      ],
      "id": "90ee7437-a720-4e05-8ad8-6dba43345252",
      "name": "Check Message Type"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "text": "è¿™æ˜¯ä¸€å¼ è´­ç‰©å°ç¥¨ã€‚è¯·æå–æ‰€æœ‰å•†å“ä¿¡æ¯ï¼Œè¿”å›žJSONæ ¼å¼ã€‚\n\nè¦æ±‚ï¼š\n1. è¿”å›žä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå•†å“æ˜¯ä¸€ä¸ªå¯¹è±¡\n2. åŒ…å«å­—æ®µï¼šnameï¼ˆå•†å“åï¼‰, priceï¼ˆä»·æ ¼ï¼Œæ•°å­—ç±»åž‹ï¼‰\n3. åªæå–å•†å“ï¼Œå¿½ç•¥å°è®¡ã€ç¨Žã€æ€»è®¡ç­‰\n4. å¦‚æžœä»·æ ¼çœ‹ä¸æ¸…ï¼Œç”¨null\n\nç¤ºä¾‹è¾“å‡ºï¼š\n[\n  {\"name\": \"Organic Milk\", \"price\": 4.99},\n  {\"name\": \"Eggs\", \"price\": 3.49}\n]\n\nåªè¿”å›žJSONæ•°ç»„ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚",
        "inputType": "base64",
        "options": {
          "detail": "high",
          "maxTokens": 2000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        464,
        -16
      ],
      "id": "b8b60bc9-15db-49c1-8c09-c003a87c813a",
      "name": "Analyze Receipt",
      "credentials": {
        "openAiApi": {
          "id": "SmQB76mmH8cEGmaS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1) å–è¾“å…¥\nconst data = $input.first().json;\n\n// 2) æå–æ–‡æœ¬ï¼šå…¼å®¹å¤šç§ç»“æž„\nfunction pickText(d) {\n  if (!d) return '';\n\n  // Analyze Image å¸¸è§ï¼š[[{ content: [{ text }] }]]\n  if (Array.isArray(d) && Array.isArray(d[0]) && d[0][0]?.content?.[0]?.text) {\n    return d[0][0].content[0].text;\n  }\n  // å¦ä¸€ç§ï¼š[{ content: [{ text }] }]\n  if (Array.isArray(d) && d[0]?.content?.[0]?.text) {\n    return d[0].content[0].text;\n  }\n  // å¯¹è±¡ï¼š{ content: [{ text }] }\n  if (d.content?.[0]?.text) return d.content[0].text;\n\n  // æ–°ç‰ˆå¸¸è§ï¼š{ text }\n  if (typeof d.text === 'string') return d.text;\n\n  // æ—§ç‰ˆï¼š{ choices[0].message.content }\n  if (d.choices?.[0]?.message?.content) return d.choices[0].message.content;\n\n  // å…œåº•ï¼šåœ¨å¯¹è±¡é‡Œé€’å½’æ‰¾ç¬¬ä¸€ä¸ªåƒ JSON çš„ 'text' å­—æ®µ\n  function findTextDeep(obj) {\n    if (!obj || typeof obj !== 'object') return '';\n    for (const k of Object.keys(obj)) {\n      const v = obj[k];\n      if (typeof v === 'string' && /[\\[\\{].*[\\]\\}]/s.test(v)) return v;\n      if (Array.isArray(v)) {\n        for (const it of v) {\n          const got = findTextDeep(it);\n          if (got) return got;\n        }\n      } else if (typeof v === 'object') {\n        const got = findTextDeep(v);\n        if (got) return got;\n      }\n    }\n    return '';\n  }\n  return findTextDeep(d);\n}\n\nlet rawText = pickText(data);\nif (!rawText) {\n  return [{\n    json: {\n      error: 'æœªæ‰¾åˆ°å¯è§£æžçš„æ–‡æœ¬è¾“å‡ºï¼Œè¯·æ£€æŸ¥ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡ºç»“æž„',\n      keysAtTopLevel: Object.keys(data || {}),\n      hint: 'ç¡®ä¿ Code èŠ‚ç‚¹ç›´æŽ¥è¿žæŽ¥åœ¨ Analyze Image çš„è¾“å‡ºä¹‹åŽï¼›åœ¨ Analyze Image çš„ Output é¢æ¿ç¡®è®¤ content[0].text æ˜¯å¦å­˜åœ¨'\n    }\n  }];\n}\n\n// 3) åŽ»æŽ‰ ```json ... ``` åŒ…è£¹ï¼Œåªå–ä»£ç å—å†…éƒ¨ä¼˜å…ˆ\nconst fenced = rawText.match(/```(?:json)?\\s*([\\s\\S]*?)```/i);\nlet body = fenced ? fenced[1] : rawText;\n\n// 4) åªæˆªå–æœ€å¤–å±‚æ•°ç»„å†…å®¹ï¼ˆé˜²æ­¢å‰åŽå¤šä½™æ–‡å­—ï¼‰\nconst start = body.indexOf('[');\nconst end = body.lastIndexOf(']');\nif (start !== -1 && end !== -1 && end > start) {\n  body = body.slice(start, end + 1);\n}\nbody = body.trim();\n\n// 5) è§£æž JSONï¼Œå¤±è´¥åˆ™è¿”å›žè¯Šæ–­ä¿¡æ¯\nlet items;\ntry {\n  items = JSON.parse(body);\n} catch (e) {\n  return [{\n    json: {\n      error: 'JSONè§£æžå¤±è´¥',\n      message: e.message,\n      preview: body.slice(0, 500)\n    }\n  }];\n}\n\nif (!Array.isArray(items)) {\n  return [{ json: { error: 'è§£æžç»“æžœä¸æ˜¯æ•°ç»„', previewType: typeof items } }];\n}\n\n// 6) ç»„è£…è¾“å‡º\nconst today = new Date().toISOString().split('T')[0];\nconst skip = new Set(['Bottle Deposit', 'SUBTOTAL', 'TAX', 'TOTAL']);\n\nreturn items\n  .filter(it => it && typeof it === 'object' && !skip.has(it.name))\n  .map(it => ({\n    json: {\n      date: today,\n      name: it.name ?? null,\n      price: (it.price ?? null)\n    }\n  }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -16
      ],
      "id": "e036be05-edf5-4d2d-8a30-b383c75b4d7a",
      "name": "Parse Receipt JSON"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1b6W0CCODNzvMtm7bWcpMQK85TpGPoeYvBCC0o-sAWAo",
          "mode": "list",
          "cachedResultName": "è´­ç‰©è®°å½•",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b6W0CCODNzvMtm7bWcpMQK85TpGPoeYvBCC0o-sAWAo/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b6W0CCODNzvMtm7bWcpMQK85TpGPoeYvBCC0o-sAWAo/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "date",
              "displayName": "date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "price",
              "displayName": "price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        880,
        -16
      ],
      "id": "fc538c99-7965-45b7-a629-f9f5b9e24bc1",
      "name": "Save to Google Sheets",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "ipx8U0kbhaXbpAYn",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1b6W0CCODNzvMtm7bWcpMQK85TpGPoeYvBCC0o-sAWAo",
          "mode": "list",
          "cachedResultName": "è´­ç‰©è®°å½•",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b6W0CCODNzvMtm7bWcpMQK85TpGPoeYvBCC0o-sAWAo/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1b6W0CCODNzvMtm7bWcpMQK85TpGPoeYvBCC0o-sAWAo/edit#gid=0"
        },
        "options": {
          "dataLocationOnSheet": {
            "values": {
              "rangeDefinition": "detectAutomatically"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        464,
        240
      ],
      "id": "bd782006-2539-4b09-a2ed-ed4079bdac2d",
      "name": "Read Purchase History",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "ipx8U0kbhaXbpAYn",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-5",
          "mode": "list",
          "cachedResultName": "GPT-5"
        },
        "responses": {
          "values": [
            {
              "content": "=è¿™æ˜¯æˆ‘æœ€è¿‘ä¹°çš„ä¸œè¥¿ï¼š\n{{ JSON.stringify($json.items.slice(0, 5), null, 2) }}\n\nè¯·ä»Žä¸­é€‰5-10ä¸ªä½ è§‰å¾—æˆ‘ä¸‹å‘¨å¯èƒ½éœ€è¦å†ä¹°çš„å•†å“ï¼Œè¿”å›žJSONæ ¼å¼ï¼š\n\n[\n  {\"name\": \"å•†å“å\", \"reason\": \"ç†ç”±ï¼ˆå°‘äºŽç­‰äºŽ10ä¸ªæ±‰å­—ï¼‰\"}\n]"
            },
            {
              "role": "system",
              "content": "ä½ æ˜¯ä¸€ä¸ªè´­ç‰©åˆ†æžåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„è´­ç‰©åŽ†å²æŽ¨èä¸‹å‘¨å¯èƒ½éœ€è¦è´­ä¹°çš„å•†å“ã€‚\nä½ å¿…é¡»è¿”å›žè‡³å°‘5ä¸ªæŽ¨èï¼Œå³ä½¿æ•°æ®ä¸å®Œç¾Žã€‚\næ°¸è¿œåªè¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦ä»»ä½•è§£é‡Šæˆ–markdownæ ¼å¼ã€‚"
            }
          ]
        },
        "builtInTools": {},
        "options": {
          "maxTokens": 3000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        848,
        240
      ],
      "id": "7b2edd68-37a7-4ec3-a036-74022c2c6232",
      "name": "Recommend Items",
      "executeOnce": true,
      "credentials": {
        "openAiApi": {
          "id": "SmQB76mmH8cEGmaS",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// èŽ·å–æ¨¡åž‹çš„è¾“å‡º\nconst modelOutput = $input.first().json;\n\n// æå–å†…éƒ¨æ–‡æœ¬\nconst rawText = modelOutput?.output?.[0]?.content?.[0]?.text;\n\nif (!rawText) {\n  return [{ json: { error: \"æœªæ‰¾åˆ°æ¨¡åž‹è¾“å‡ºæ–‡æœ¬\", raw: modelOutput } }];\n}\n\n// æ¸…ç†æ ¼å¼ï¼ˆåŽ»æŽ‰markdownåŒ…è£¹ç­‰ï¼‰\nlet clean = rawText.replace(/```json|```/g, '').trim();\n\n// å°è¯•è§£æžJSON\nlet items;\ntry {\n  items = JSON.parse(clean);\n} catch (e) {\n  return [{ json: { error: \"JSONè§£æžå¤±è´¥\", clean, message: e.message } }];\n}\n\n// ðŸ§© æ‹¼æŽ¥æˆä¸€æ¡ Telegram æ–‡æœ¬\nconst messageText = items\n  .map((item, i) => `#${i + 1} ðŸ›’ *${item.name}*\\nåŽŸå› : ${item.reason}`)\n  .join('\\n\\n');\n\n// âœ… è¾“å‡ºå•æ¡ itemï¼Œæ–¹ä¾¿ Telegram ç›´æŽ¥ä½¿ç”¨\nreturn [{\n  json: {\n    message: messageText\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        240
      ],
      "id": "c80f3c00-0c7c-4112-8274-39d4f2e5f9d9",
      "name": "Parse Recommendation"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "text": "=æœ¬å‘¨è´­ç‰©æŽ¨èï¼š\n{{ $json.message }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1344,
        240
      ],
      "id": "bd67a7ce-e863-4dbb-a14f-b20c977673e5",
      "name": "Send Recommendation",
      "webhookId": "eb64b23c-61f0-4d4d-8800-53f98d2feffc",
      "credentials": {
        "telegramApi": {
          "id": "LJfZKhHnl2gO8FnK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=âœ… å°ç¥¨å·²å¤„ç†ï¼     è®°å½•äº† {{ $('Parse Receipt JSON').all().length }} ä»¶å•†å“    æ€»è®¡ï¼š${{ $('Parse Receipt JSON').all().reduce((sum, item) => sum + (item.json.price || 0), 0).toFixed(2) }}     å·²ä¿å­˜åˆ°Google Sheets ðŸ“Š",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1088,
        -16
      ],
      "id": "8e6b8f40-6205-4c5e-8d9b-8a3f38388c5e",
      "name": "Confirm Save",
      "webhookId": "7d947d21-a45d-4685-ac82-ed1c901cb587",
      "executeOnce": true,
      "credentials": {
        "telegramApi": {
          "id": "LJfZKhHnl2gO8FnK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all().map(item => item.json);\n\n// æŒ‰å•†å“åˆ†ç»„\nconst itemStats = {};\n\nallItems.forEach(item => {\n  const name = item.name;\n  if (!itemStats[name]) {\n    itemStats[name] = {\n      name: name,\n      prices: [],\n      dates: []\n    };\n  }\n  itemStats[name].prices.push(item.price || 0);\n  itemStats[name].dates.push(item.date);\n});\n\n// è®¡ç®—åŸºç¡€ç»Ÿè®¡\nconst results = Object.values(itemStats).map(item => {\n  // æŽ’åºæ—¥æœŸ\n  const sortedDates = item.dates.sort();\n  \n  // è®¡ç®—é—´éš”ï¼ˆå¦‚æžœä¹°è¿‡å¤šæ¬¡ï¼‰\n  let intervals = [];\n  if (sortedDates.length > 1) {\n    for (let i = 1; i < sortedDates.length; i++) {\n      const days = (new Date(sortedDates[i]) - new Date(sortedDates[i-1])) / (1000 * 60 * 60 * 24);\n      intervals.push(days);\n    }\n  }\n  \n  // è·ä»Šå¤©æ•°\n  const lastDate = new Date(sortedDates[sortedDates.length - 1]);\n  const today = new Date();\n  const daysSince = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));\n  \n  return {\n    name: item.name,\n    purchaseCount: sortedDates.length,\n    purchaseDates: sortedDates,\n    avgPrice: (item.prices.reduce((a,b) => a+b, 0) / item.prices.length).toFixed(2),\n    daysSinceLastPurchase: daysSince,\n    avgIntervalDays: intervals.length > 0 ? Math.round(intervals.reduce((a,b) => a+b) / intervals.length) : null,\n    allIntervals: intervals\n  };\n});\n\n// æŒ‰è´­ä¹°é¢‘çŽ‡æŽ’åºï¼ˆå¸¸ä¹°çš„åœ¨å‰ï¼‰\nresults.sort((a, b) => b.purchaseCount - a.purchaseCount);\n\nreturn [{\n  json: {\n    items: results,\n    totalUniqueItems: results.length,\n    analysisDate: new Date().toISOString().split('T')[0]\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        240
      ],
      "id": "87c593f2-0bce-447d-95df-1d46a32b9a8a",
      "name": "Parse Purchase History"
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Check Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Message Type": {
      "main": [
        [
          {
            "node": "Analyze Receipt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Read Purchase History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Receipt": {
      "main": [
        [
          {
            "node": "Parse Receipt JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Receipt JSON": {
      "main": [
        [
          {
            "node": "Save to Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Google Sheets": {
      "main": [
        [
          {
            "node": "Confirm Save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Purchase History": {
      "main": [
        [
          {
            "node": "Parse Purchase History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recommend Items": {
      "main": [
        [
          {
            "node": "Parse Recommendation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Recommendation": {
      "main": [
        [
          {
            "node": "Send Recommendation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Purchase History": {
      "main": [
        [
          {
            "node": "Recommend Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a0b78bdf-5ed3-4d54-9046-b71d6c65d49c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ac16e6d9ad301564e0715617d5d1ccec1e5a506281b26e69b95d5511ec79ee54"
  },
  "id": "WcAxdEIldutlTi8c",
  "tags": []
}
